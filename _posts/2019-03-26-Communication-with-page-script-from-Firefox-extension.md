---
title: Communication between page script and Firefox extension
published: true
---

### [](#header-3)The problem:

Few days ago I wrote a [tool](automation-of-knoxss-extension) which automates Knoxss extension. In the beginning my tool was not able to communicate with extension so I couldn't read its status and so on. I had information generated by extension in background script and needed to receive it in page script and handle in Python. The problem was that every solution I found described communication from HTML page to extension but I needed something opposite. Second problem: I'm not a JavaScript programmer :)
    
### Toolbelt:

- geckodriver 0.23.0 ( 2018-10-04)
- Mozilla Firefox 67.0b4 Developer Edition
- Selenium 3.141.0
- KNOXSS Add-on 1.2.0
- Python 3.6.5

### What I found:

I've found plenty of Stackoverflow drips but it were to complicated for my problem or described communication in the opposite direction. 

1. [Communication between HTML and your extension](https://developer.mozilla.org/en-US/docs/Archive/Add-ons/Communication_between_HTML_and_your_extension) - described usage of custom events which gave me an idea of trying it
2. [Communicating with background scripts](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts#Communicating_with_background_scripts)
3. [Can my webdriver script catch a event from the webpage](https://stackoverflow.com/questions/35884230/can-my-webdriver-script-catch-a-event-from-the-webpage) - catching JavaScript events by Selenium Webdriver


### What I tried:

1. Intercepting Console API entries in Selenium - [Support for Seleniumâ€™s logging interface](https://github.com/mozilla/geckodriver/issues/284) - didn't work for me
2. Communicating with alert box (editing extension code and adding `alert(status)` somewhere in msgKnoxss function - possible but not elegant.

### Some theory about extensions:

Extensions are HTML and JavaScript code running along the browser. Is has XPI extension which is normall **ZIP** archive so we can edit it easly.

![manifest.json](https://mdn.mozillademos.org/files/13669/webextension-anatomy.png){:height="100px"}.

There are three different types of JavaScript code when talking about extensions:

| Name  | Properties |
| ------------- | ------------- |
| Page script  | Code running in context of the web page. I **can** inject code here using Selenium|
| Content script  | Part of the extension but running in context of the web page. So-called **proxy**     |
| Background script  | Logic of the extension, **could not** communicate with page script directly - my purpose - but can inject code as content script |

As mentioned [here](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts#Communicating_with_background_scripts):
> There are two basic patterns for communicating between the background scripts and content scripts: you can send one-off messages, with an optional response, or you can set up a longer-lived connection between the two sides, and use that connection to exchange messages.

Everything looks great in first sight, but lets look on the code:

```javascript
// content-script.js

window.addEventListener("click", notifyExtension);

function notifyExtension(e) {
  if (e.target.tagName != "A") {
    return;
  }
  browser.runtime.sendMessage({"url": e.target.href});
}
```

```javascript
// background-script.js

browser.runtime.onMessage.addListener(notify);

function notify(message) {
  browser.notifications.create({
    "type": "basic",
    "iconUrl": browser.extension.getURL("link.png"),
    "title": "You clicked a link!",
    "message": message.url
  });
}
```
This would be helpful if we want to send a message from Content script and receive it in Background script, but I need to do something opposite. Second described operations would do it for us, but it looked to complicated for me.

I know that JavaScript allow us to send **events** to HTML tags and saw that Selenium allows to catch those events, so lets look closer to that mechanism.

### 
